<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINK Expert | Majdoul Tower</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --royal-black: #080808;
            --royal-gold: #c5a059;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(197, 160, 89, 0.3);
        }

        body {
            margin: 0; background: var(--royal-black); color: #fff;
            font-family: 'Segoe UI', sans-serif; overflow-x: hidden;
        }

        /* Access Gate */
        #gate {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: flex; align-items: center; justify-content: center;
        }

        .glass-card {
            background: var(--glass); backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border); border-radius: 15px;
            padding: 30px; text-align: center; width: 300px;
        }

        input, select {
            background: rgba(255,255,255,0.1); border: 1px solid var(--royal-gold);
            color: #fff; padding: 12px; border-radius: 5px; width: 100%; margin: 10px 0; box-sizing: border-box;
        }

        button {
            background: var(--royal-gold); color: #000; border: none;
            padding: 12px; border-radius: 5px; font-weight: bold; cursor: pointer; width: 100%;
        }

        /* Layout */
        #app { display: none; padding-bottom: 80px; }
        header { padding: 20px; border-bottom: 1px solid var(--glass-border); text-align: center; }
        .section { padding: 20px; max-width: 800px; margin: auto; display: none; }
        .active { display: block; }

        /* Vehicle Result Cards */
        .v-card {
            background: var(--glass); border: 1px solid var(--glass-border);
            padding: 15px; border-radius: 10px; margin: 10px 0;
            border-left: 5px solid var(--royal-gold);
        }

        /* Permit Export Area */
        #permit-export {
            width: 210mm; height: 148mm; background: #fff; color: #000;
            padding: 40px; margin: 20px auto; position: relative; box-sizing: border-box;
        }
        .permit-box { border: 2px solid #000; padding: 20px; height: 100%; position: relative; }

        /* Navigation */
        nav {
            position: fixed; bottom: 0; width: 100%; background: #000;
            display: flex; justify-content: space-around; padding: 15px 0;
            border-top: 1px solid var(--royal-gold);
        }
        .nav-link { color: var(--royal-gold); text-decoration: none; font-size: 12px; cursor: pointer; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; color: #000; }
    </style>
</head>
<body>

    <div id="gate">
        <div class="glass-card">
            <h2 style="color:var(--royal-gold)">MAJDOUL TOWER</h2>
            <input type="password" id="pass" placeholder="Pass Key" oninput="if(this.value=='0107') unlock()">
        </div>
    </div>

    <div id="app">
        <header>
            <h2 style="color:var(--royal-gold)">LINK EXPERT OPERATIONS</h2>
        </header>

        <div id="sec-dash" class="section active">
            <div class="glass-card" style="width:100%">
                <h3>Daily Parking Stats</h3>
                <canvas id="parkChart"></canvas>
                <div style="margin-top:20px;">
                    <input type="file" id="csvIn" accept=".csv">
                    <button onclick="loadCSV()">Import Baseline Data</button>
                </div>
            </div>
        </div>

        <div id="sec-inv" class="section">
            <h3>Vehicle Management</h3>
            <input type="text" id="vSearch" placeholder="Search Name or Plate..." onkeyup="searchVehicle()">
            <div id="searchResults"></div>

            <div id="parking-step" class="glass-card" style="display:none; width:100%; margin-top:20px;">
                <h4 id="sel-vehicle-title"></h4>
                <select id="p-opt">
                    <option>Landscaped</option><option>P1-VIP</option>
                    <option>P1</option><option>P2</option>
                    <option>P3</option><option>P4</option>
                </select>
                <input type="text" id="p-slot" placeholder="Lot Number">
                <button onclick="submitParking()">Confirm Assignment</button>
            </div>
        </div>

        <div id="sec-perm" class="section">
            <h3>Generate Permit</h3>
            <select id="perm-type" onchange="toggleLabor()">
                <option value="labor">Personnel/Labor Entry</option>
                <option value="mat-in">Material Entry</option>
                <option value="mat-out">Material Exit</option>
            </select>
            <input type="text" id="pm-co" placeholder="Company Name">
            <input type="text" id="pm-unit" placeholder="Unit Number">
            <input type="text" id="pm-name" placeholder="Holder Name">
            <input type="text" id="pm-id" placeholder="ID Number">
            <input type="text" id="pm-phone" placeholder="Phone Number">
            <input type="date" id="pm-date">

            <div id="labor-entry">
                <h4>Labor List</h4>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="l-name" placeholder="Name">
                    <input type="text" id="l-id" placeholder="ID">
                    <input type="text" id="l-job" placeholder="Job">
                    <button onclick="addLabor()" style="width:50px">+</button>
                </div>
                <div id="l-list-preview" style="font-size:11px; margin-top:10px;"></div>
            </div>

            <button onclick="renderPermit()" style="margin-top:20px;">Generate Digital Card</button>

            <div id="permit-export" style="display:none;">
                <div class="permit-box">
                    <div style="display:flex; justify-content:space-between">
                        <div>
                            <h2 id="exp-type">PERSONNEL</h2>
                            <p>Majdoul Tower | LINK Expert</p>
                        </div>
                        <div id="qr"></div>
                    </div>
                    <hr>
                    <p><strong>Company:</strong> <span id="exp-co"></span></p>
                    <p><strong>Holder:</strong> <span id="exp-hold"></span> | <strong>Unit:</strong> <span id="exp-u"></span></p>
                    <div id="exp-table-area"></div>
                    <p style="position:absolute; bottom:20px; font-size:10px;">Duration: <span id="exp-d"></span></p>
                </div>
            </div>
            <button id="exp-btn" style="display:none; margin-top:10px;" onclick="saveImage('permit-export', 'Permit')">Export Image</button>
        </div>

        <div id="sec-att" class="section">
            <h3>Staff Attendance Builder</h3>
            <div class="glass-card" style="width:100%; text-align:left;">
                <select id="att-pos">
                    <option>Operation Manager</option><option>Supervisor</option>
                    <option>Team Leader</option><option>Valet</option>
                    <option>Gate Operator</option><option>Traffic Marshal</option>
                </select>
                <input type="text" id="att-name" placeholder="Employee Name">
                <select id="att-shift"><option>Morning</option><option>Night</option></select>
                <button onclick="addAttendance()">Add Employee</button>
            </div>

            <div id="att-paper" style="background:white; color:black; padding:30px; margin-top:20px; display:none;">
                <center><h2>LINK Expert Attendance</h2></center>
                <p>Date: <span id="att-date-ui"></span></p>
                <table id="att-table">
                    <thead><tr><th>Position</th><th>Name</th><th>Shift</th></tr></thead>
                    <tbody id="att-rows"></tbody>
                </table>
            </div>
            <button id="att-exp-btn" style="display:none; margin-top:10px;" onclick="saveImage('att-paper', 'Attendance')">Export Attendance Paper</button>
        </div>

        <nav>
            <div class="nav-link" onclick="show('dash')">DASHBOARD</div>
            <div class="nav-link" onclick="show('inv')">INVENTORY</div>
            <div class="nav-link" onclick="show('perm')">PERMITS</div>
            <div class="nav-link" onclick="show('att')">ATTENDANCE</div>
        </nav>
    </div>

<script>
    let masterData = [];
    let parkingStats = { Landscaped: 0, "P1-VIP": 0, P1: 0, P2: 0, P3: 0, P4: 0 };
    let laborTemp = [];
    let selectedVehicle = null;

    function unlock() { 
        document.getElementById('gate').style.display = 'none'; 
        document.getElementById('app').style.display = 'block';
        initChart();
    }

    function show(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById('sec-'+id).classList.add('active');
    }

    function loadCSV() {
        const file = document.getElementById('csvIn').files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const rows = e.target.result.split('\n').slice(1);
            masterData = rows.map(r => {
                const c = r.split(',');
                return { client: c[0], plate: c[1], model: c[2], color: c[3], emp: c[4] };
            });
            alert("Baseline Loaded: " + masterData.length + " vehicles");
        };
        reader.readAsText(file);
    }

    function searchVehicle() {
        const query = document.getElementById('vSearch').value.toLowerCase();
        const results = masterData.filter(v => v.client?.toLowerCase().includes(query) || v.plate?.toLowerCase().includes(query));
        let html = "";
        results.forEach((v, idx) => {
            html += `<div class="v-card" onclick="selectVehicle(${idx})">
                <strong>${v.client}</strong><br>${v.plate} - ${v.model} (${v.color})
            </div>`;
        });
        document.getElementById('searchResults').innerHTML = html;
    }

    function selectVehicle(idx) {
        selectedVehicle = masterData[idx];
        document.getElementById('sel-vehicle-title').innerText = "Assign: " + selectedVehicle.plate;
        document.getElementById('parking-step').style.display = 'block';
    }

    function submitParking() {
        const opt = document.getElementById('p-opt').value;
        parkingStats[opt]++;
        updateChart();
        alert("Vehicle assigned to " + opt);
        document.getElementById('parking-step').style.display = 'none';
        document.getElementById('vSearch').value = "";
        document.getElementById('searchResults').innerHTML = "";
    }

    function addLabor() {
        const n = document.getElementById('l-name').value;
        const i = document.getElementById('l-id').value;
        const j = document.getElementById('l-job').value;
        laborTemp.push({n, i, j});
        document.getElementById('l-list-preview').innerHTML += `<div>${n} (${j})</div>`;
    }

    function renderPermit() {
        document.getElementById('exp-type').innerText = document.getElementById('perm-type').value.toUpperCase();
        document.getElementById('exp-co').innerText = document.getElementById('pm-co').value;
        document.getElementById('exp-hold').innerText = document.getElementById('pm-name').value;
        document.getElementById('exp-u').innerText = document.getElementById('pm-unit').value;
        document.getElementById('exp-d').innerText = document.getElementById('pm-date').value;

        if(document.getElementById('perm-type').value === 'labor') {
            let h = `<table><tr><th>Name</th><th>ID No</th><th>Job</th></tr>`;
            laborTemp.forEach(l => h += `<tr><td>${l.n}</td><td>${l.i}</td><td>${l.j}</td></tr>`);
            document.getElementById('exp-table-area').innerHTML = h + `</table>`;
        }

        document.getElementById('qr').innerHTML = "";
        new QRCode(document.getElementById("qr"), { text: "MT-"+Date.now(), width: 60, height: 60 });
        document.getElementById('permit-export').style.display = 'block';
        document.getElementById('exp-btn').style.display = 'block';
    }

    function addAttendance() {
        const pos = document.getElementById('att-pos').value;
        const name = document.getElementById('att-name').value;
        const shift = document.getElementById('att-shift').value;
        document.getElementById('att-rows').innerHTML += `<tr><td>${pos}</td><td>${name}</td><td>${shift}</td></tr>`;
        document.getElementById('att-paper').style.display = 'block';
        document.getElementById('att-exp-btn').style.display = 'block';
        document.getElementById('att-date-ui').innerText = new Date().toLocaleDateString();
    }

    function saveImage(id, name) {
        html2canvas(document.getElementById(id)).then(canvas => {
            const link = document.createElement('a');
            link.download = `Majdoul_${name}.png`;
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    let chart;
    function initChart() {
        const ctx = document.getElementById('parkChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'bar',
            data: { labels: Object.keys(parkingStats), datasets: [{ label: 'Cars', data: Object.values(parkingStats), backgroundColor: '#c5a059' }]},
            options: { scales: { y: { beginAtZero: true, grid: { color: '#333' }}}}
        });
    }
    function updateChart() {
        chart.data.datasets[0].data = Object.values(parkingStats);
        chart.update();
    }
</script>
</body>
</html>
