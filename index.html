<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINK Expert | Majdoul Tower OS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --royal-black: #080808;
            --royal-gold: #c5a059;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(197, 160, 89, 0.3);
        }

        body {
            margin: 0; background: var(--royal-black); color: #fff;
            font-family: 'Segoe UI', sans-serif;
        }

        #gate {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: flex; align-items: center; justify-content: center;
        }

        .glass-card {
            background: var(--glass); backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border); border-radius: 15px;
            padding: 25px; margin-bottom: 20px;
        }

        input, select {
            background: rgba(255,255,255,0.1); border: 1px solid var(--royal-gold);
            color: #fff; padding: 12px; border-radius: 5px; width: 100%; margin: 8px 0; box-sizing: border-box;
        }

        button {
            background: var(--royal-gold); color: #000; border: none;
            padding: 12px; border-radius: 5px; font-weight: bold; cursor: pointer; width: 100%;
        }

        #app { display: none; padding-bottom: 100px; }
        .section { padding: 20px; max-width: 900px; margin: auto; display: none; }
        .active { display: block; }

        /* Vehicle Cards */
        .v-card {
            background: var(--glass); border: 1px solid var(--glass-border);
            padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 5px solid var(--royal-gold);
            cursor: pointer;
        }

        /* PERMIT EXPORT - A4 Logic */
        #permit-export {
            width: 800px; background: #fff; color: #000;
            padding: 40px; margin: 20px auto; border: 1px solid #ddd;
        }
        .permit-box { border: 3px solid #000; padding: 30px; position: relative; min-height: 400px; }
        .permit-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .permit-table th, .permit-table td { border: 1px solid #000; padding: 10px; text-align: left; }

        /* Nav */
        nav {
            position: fixed; bottom: 0; width: 100%; background: #000;
            display: flex; justify-content: space-around; padding: 15px 0;
            border-top: 1px solid var(--royal-gold); z-index: 1000;
        }
        .nav-link { color: var(--royal-gold); text-decoration: none; font-size: 11px; cursor: pointer; }

        #att-paper { background: white; color: black; padding: 40px; border: 1px solid #ccc; }
    </style>
</head>
<body>

    <div id="gate">
        <div class="glass-card" style="width:300px; text-align:center;">
            <h2 style="color:var(--royal-gold)">MAJDOUL TOWER</h2>
            <input type="password" id="pass" placeholder="Pass Key" oninput="if(this.value=='0107') unlock()">
        </div>
    </div>

    <div id="app">
        <div id="sec-dash" class="section active">
            <h1 style="color:var(--royal-gold)">DASHBOARD</h1>
            <div class="glass-card">
                <h3>Daily Parking Distribution</h3>
                <canvas id="parkChart" height="100"></canvas>
            </div>
            <div class="glass-card">
                <h3>Import Operational Data</h3>
                <input type="file" id="csvIn" accept=".csv">
                <button onclick="loadCSV()">Sync Vehicle Database</button>
            </div>
        </div>

        <div id="sec-inv" class="section">
            <h1>Vehicle Search & Parking</h1>
            <input type="text" id="vSearch" placeholder="Search Plate or Name..." onkeyup="searchVehicle()">
            <div id="searchResults"></div>

            <div id="parking-step" class="glass-card" style="display:none; margin-top:20px;">
                <h3 id="sel-vehicle-title"></h3>
                <select id="p-opt">
                    <option>Landscaped</option><option>P1-VIP</option>
                    <option>P1</option><option>P2</option><option>P3</option><option>P4</option>
                </select>
                <input type="text" id="p-slot" placeholder="Lot Number">
                <button onclick="submitParking()">Confirm Assignment</button>
            </div>
        </div>

        <div id="sec-perm" class="section">
            <h1>Permit Center</h1>
            <div class="glass-card">
                <select id="perm-type" onchange="updatePermitUI()">
                    <option value="labor">Personnel / Labor Entry</option>
                    <option value="mat-in">Material Permit ENTRY</option>
                    <option value="mat-out">Material Permit EXIT</option>
                </select>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <input type="text" id="pm-co" placeholder="Company Name">
                    <input type="text" id="pm-unit" placeholder="Unit Number">
                    <input type="text" id="pm-name" placeholder="Holder Name">
                    <input type="text" id="pm-id" placeholder="Holder ID">
                    <input type="text" id="pm-phone" placeholder="Phone Number">
                    <input type="date" id="pm-date">
                </div>

                <div id="dynamic-table-section" style="margin-top:15px; border-top:1px solid var(--glass-border); padding-top:15px;">
                    <h4 id="table-title">Add Labor Personnel</h4>
                    <div id="input-row" style="display:flex; gap:5px;">
                        <input type="text" id="col1" placeholder="Name">
                        <input type="text" id="col2" placeholder="ID Number">
                        <input type="text" id="col3" placeholder="Job Title">
                        <button onclick="addRow()" style="width:60px;">+</button>
                    </div>
                    <div id="temp-list" style="font-size:12px; margin-top:10px; color:var(--royal-gold)"></div>
                </div>
                <button onclick="renderPermit()" style="margin-top:20px;">Preview Permit Card</button>
            </div>

            <div id="permit-export" style="display:none;">
                <div class="permit-box">
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <div>
                            <h1 id="exp-type" style="margin:0; font-size:28px;"></h1>
                            <p style="margin:5px 0;">MAJDOUL TOWER | Operation: LINK EXPERT</p>
                        </div>
                        <div id="qr"></div>
                    </div>
                    <hr style="border:1px solid #000; margin:20px 0;">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; font-size:14px;">
                        <div><strong>Company:</strong> <span id="out-co"></span></div>
                        <div><strong>Unit:</strong> <span id="out-unit"></span></div>
                        <div><strong>Holder:</strong> <span id="out-hold"></span></div>
                        <div><strong>Contact:</strong> <span id="out-phone"></span></div>
                    </div>
                    <div id="out-table-container"></div>
                    <div style="margin-top:30px; font-size:12px;"><strong>Valid Date:</strong> <span id="out-date"></span></div>
                </div>
            </div>
            <button id="exp-btn" style="display:none; margin-top:10px;" onclick="saveImage('permit-export', 'Permit')">Export A4 Image</button>
        </div>

        <div id="sec-att" class="section">
            <h1>Attendance Builder</h1>
            <div class="glass-card">
                <select id="att-pos">
                    <option>Operation Manager</option><option>Supervisor Operation</option>
                    <option>Team Leader</option><option>Valet</option>
                    <option>Gate Operator</option><option>Traffic Marshal</option>
                </select>
                <input type="text" id="att-name" placeholder="Employee Name">
                <select id="att-shift"><option>Morning Shift</option><option>Night Shift</option></select>
                <button onclick="addAtt()">Add Employee to Sheet</button>
            </div>

            <div id="att-paper" style="display:none; margin-top:20px;">
                <h2 style="text-align:center; border:none; padding:0;">LINK EXPERT ATTENDANCE</h2>
                <p>Facility: Majdoul Tower | Date: <span id="att-date-ui"></span></p>
                <table class="permit-table">
                    <thead><tr><th>Position</th><th>Employee Name</th><th>Shift</th><th>Signature</th></tr></thead>
                    <tbody id="att-rows"></tbody>
                </table>
            </div>
            <button id="att-exp-btn" style="display:none; margin-top:10px;" onclick="saveImage('att-paper', 'Attendance')">Export Attendance Sheet</button>
        </div>

        <nav>
            <div class="nav-link" onclick="show('dash')">DASHBOARD</div>
            <div class="nav-link" onclick="show('inv')">INVENTORY</div>
            <div class="nav-link" onclick="show('perm')">PERMITS</div>
            <div class="nav-link" onclick="show('att')">ATTENDANCE</div>
        </nav>
    </div>

<script>
    let masterData = [];
    let parkingStats = { Landscaped: 0, "P1-VIP": 0, P1: 0, P2: 0, P3: 0, P4: 0 };
    let tableData = [];
    let selectedVehicle = null;

    function unlock() { 
        document.getElementById('gate').style.display = 'none'; 
        document.getElementById('app').style.display = 'block';
        initChart();
    }

    function show(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById('sec-'+id).classList.add('active');
    }

    function loadCSV() {
        const file = document.getElementById('csvIn').files[0];
        if(!file) return alert("Select file");
        const reader = new FileReader();
        reader.onload = (e) => {
            const lines = e.target.result.split('\n').slice(1);
            masterData = lines.map(line => {
                const parts = line.split(',');
                return { client: parts[0], plate: parts[1], model: parts[2], color: parts[3], emp: parts[4] };
            });
            alert("Loaded " + masterData.length + " vehicle records.");
        };
        reader.readAsText(file);
    }

    function searchVehicle() {
        const q = document.getElementById('vSearch').value.toLowerCase();
        const results = masterData.filter(v => v.plate?.toLowerCase().includes(q) || v.client?.toLowerCase().includes(q));
        let h = "";
        results.forEach((v, idx) => {
            h += `<div class="v-card" onclick="selectVehicle(${idx})"><b>${v.plate}</b> - ${v.client}<br><small>${v.model} | ${v.color}</small></div>`;
        });
        document.getElementById('searchResults').innerHTML = h;
    }

    function selectVehicle(idx) {
        selectedVehicle = masterData[idx];
        document.getElementById('sel-vehicle-title').innerText = "Assign Plate: " + selectedVehicle.plate;
        document.getElementById('parking-step').style.display = 'block';
    }

    function submitParking() {
        const opt = document.getElementById('p-opt').value;
        parkingStats[opt]++;
        updateChart();
        document.getElementById('parking-step').style.display = 'none';
        document.getElementById('vSearch').value = "";
        document.getElementById('searchResults').innerHTML = "";
        alert("Saved to " + opt);
    }

    // Permit Logic
    function updatePermitUI() {
        const type = document.getElementById('perm-type').value;
        const col1 = document.getElementById('col1');
        const col2 = document.getElementById('col2');
        const col3 = document.getElementById('col3');
        tableData = []; document.getElementById('temp-list').innerHTML = "";

        if(type === 'labor') {
            document.getElementById('table-title').innerText = "Add Labor Personnel";
            col1.placeholder = "Name"; col2.placeholder = "ID Number"; col3.placeholder = "Job Title";
            col3.style.display = "block";
        } else {
            document.getElementById('table-title').innerText = "Add Material Details";
            col1.placeholder = "Material Kind"; col2.placeholder = "Quantity";
            col3.style.display = "none";
        }
    }

    function addRow() {
        const c1 = document.getElementById('col1').value;
        const c2 = document.getElementById('col2').value;
        const c3 = document.getElementById('col3').value;
        tableData.push({c1, c2, c3});
        document.getElementById('temp-list').innerHTML += `<div>â€¢ ${c1} - ${c2} ${c3}</div>`;
        document.getElementById('col1').value = ""; document.getElementById('col2').value = ""; document.getElementById('col3').value = "";
    }

    function renderPermit() {
        const type = document.getElementById('perm-type').value;
        document.getElementById('exp-type').innerText = type === 'labor' ? "PERSONNEL PERMIT" : (type === 'mat-in' ? "MATERIAL ENTRY" : "MATERIAL EXIT");
        document.getElementById('out-co').innerText = document.getElementById('pm-co').value;
        document.getElementById('out-unit').innerText = document.getElementById('pm-unit').value;
        document.getElementById('out-hold').innerText = document.getElementById('pm-name').value;
        document.getElementById('out-phone').innerText = document.getElementById('pm-phone').value;
        document.getElementById('out-date').innerText = document.getElementById('pm-date').value;

        let h = `<table class="permit-table"><thead><tr>`;
        if(type === 'labor') {
            h += `<th>Name</th><th>ID No</th><th>Job Title</th></tr></thead><tbody>`;
            tableData.forEach(r => h += `<tr><td>${r.c1}</td><td>${r.c2}</td><td>${r.c3}</td></tr>`);
        } else {
            h += `<th>Material Kind</th><th>Quantity</th></tr></thead><tbody>`;
            tableData.forEach(r => h += `<tr><td>${r.c1}</td><td>${r.c2}</td></tr>`);
        }
        h += `</tbody></table>`;
        document.getElementById('out-table-container').innerHTML = h;

        document.getElementById('qr').innerHTML = "";
        new QRCode(document.getElementById("qr"), { text: "MAJ-"+Date.now(), width: 80, height: 80 });
        document.getElementById('permit-export').style.display = 'block';
        document.getElementById('exp-btn').style.display = 'block';
    }

    // Attendance Logic
    function addAtt() {
        const p = document.getElementById('att-pos').value;
        const n = document.getElementById('att-name').value;
        const s = document.getElementById('att-shift').value;
        document.getElementById('att-rows').innerHTML += `<tr><td>${p}</td><td>${n}</td><td>${s}</td><td></td></tr>`;
        document.getElementById('att-date-ui').innerText = new Date().toLocaleDateString();
        document.getElementById('att-paper').style.display = 'block';
        document.getElementById('att-exp-btn').style.display = 'block';
    }

    function saveImage(id, name) {
        html2canvas(document.getElementById(id), {scale: 2}).then(canvas => {
            const link = document.createElement('a');
            link.download = `Majdoul_${name}_${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    let chart;
    function initChart() {
        const ctx = document.getElementById('parkChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'bar',
            data: { labels: Object.keys(parkingStats), datasets: [{ label: 'Cars Today', data: Object.values(parkingStats), backgroundColor: '#c5a059' }]},
            options: { responsive: true, scales: { y: { beginAtZero: true, grid: { color: '#333' }}}}
        });
    }
    function updateChart() {
        chart.data.datasets[0].data = Object.values(parkingStats);
        chart.update();
    }
</script>
</body>
</html>
