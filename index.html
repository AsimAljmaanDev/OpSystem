<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ÙˆØ§Ù‚Ù Ù…Ø¬Ø¯ÙˆÙ„ - Ø§Ù„ÙØ­Øµ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --primary: #4f46e5; --success: #10b981; --error: #ef4444; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #f1f5f9; }
        
        #camera-ui { display: none; position: fixed; inset: 0; background: #000; z-index: 2000; }
        #video { width: 100%; height: 100%; object-fit: cover; }
        
        .overlay { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /* Ø¥Ø·Ø§Ø± Ø§Ù„ÙØ­Øµ */
        .focus-box {
            width: 80%; height: 100px; border: 3px solid #fff; border-radius: 12px;
            box-shadow: 0 0 0 5000px rgba(0,0,0,0.8); position: relative;
        }
        .focus-box.scanning { border-color: #fb8c00; animation: pulse 1s infinite; }
        .focus-box.matched { border-color: var(--success); box-shadow: 0 0 30px var(--success), 0 0 0 5000px rgba(0,0,0,0.6); }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .hint { position: absolute; top: -40px; width: 100%; text-align: center; color: #fff; font-size: 0.9rem; }
        .btn-trigger { 
            position: absolute; bottom: 80px; width: 80px; height: 80px; 
            background: #fff; border-radius: 50%; border: 8px solid var(--primary); 
            cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;
        }
        
        .container { padding: 20px; max-width: 500px; margin: auto; }
        .glass { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        
        .result-card { background: #fff; margin-top: 20px; padding: 20px; border-radius: 15px; border-right: 6px solid var(--primary); text-align: right; }
        .row { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
    </style>
</head>
<body>

<div id="camera-ui">
    <video id="video" autoplay playsinline></video>
    <div class="overlay">
        <div id="fBox" class="focus-box">
            <div id="statusText" class="hint">Ø«Ø¨Øª Ø§Ù„Ù„ÙˆØ­Ø© ÙˆØ§Ø¶ØºØ· Ø§Ù„Ø²Ø±</div>
        </div>
        <button id="mainBtn" class="btn-trigger" onclick="processLicensePlate()">ğŸ”</button>
        <button onclick="closeCam()" style="position:absolute; bottom:30px; color:#fff; background:none; border:none;">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>

<div class="container">
    <div class="glass">
        <h2 style="color:var(--primary)">Ù…ÙˆØ§Ù‚Ù Ù…Ø¬Ø¯ÙˆÙ„</h2>
        <button onclick="openCam()" style="width:100%; padding:15px; background:var(--primary); color:#fff; border:none; border-radius:12px; font-weight:bold; cursor:pointer;">ğŸ“· Ù…Ø³Ø­ Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø¢Ù†</button>
        <input type="text" id="manualInp" placeholder="Ø£Ùˆ Ø§Ø¨Ø­Ø« ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù‡Ù†Ø§" style="width:100%; margin-top:15px; padding:12px; border-radius:8px; border:1px solid #ddd; text-align:center;">
    </div>
    <div id="results"></div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyCmZCoItc1KTDPP_afzdhC5T-Vz8z6e11iVN9etRXpqj7Ecfm1O5ml0uqWVX7nJPBx/exec";
    let dataStore = [];
    let stream = null;
    let worker = null;

    async function loadData() {
        try { const r = await fetch(SCRIPT_URL); dataStore = await r.json(); } catch(e) {}
    }

    async function openCam() {
        if(!worker) {
            worker = await Tesseract.createWorker('eng');
            await worker.setParameters({ tessedit_char_whitelist: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ' });
        }
        document.getElementById('camera-ui').style.display = 'block';
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        document.getElementById('video').srcObject = stream;
    }

    async function processLicensePlate() {
        const box = document.getElementById('fBox');
        const txt = document.getElementById('statusText');
        const btn = document.getElementById('mainBtn');

        box.className = 'focus-box scanning';
        txt.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ©...";
        btn.style.display = 'none';

        const video = document.getElementById('video');
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        // 1. Ù‚Øµ Ø§Ù„ØµÙˆØ±Ø© (Crop)
        canvas.width = 600; canvas.height = 200;
        ctx.drawImage(video, video.videoWidth*0.1, video.videoHeight*0.4, video.videoWidth*0.8, video.videoHeight*0.2, 0, 0, 600, 200);

        // 2. ØªØ­Ø³ÙŠÙ† Ø§Ù„ØµÙˆØ±Ø© (Grayscale & Threshold) Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
        let imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        let pixels = imgData.data;
        for (let i = 0; i < pixels.length; i += 4) {
            let avg = (pixels[i] + pixels[i+1] + pixels[i+2]) / 3;
            let res = avg > 120 ? 255 : 0; // ØªØ­ÙˆÙŠÙ„ Ù„Ø£Ø¨ÙŠØ¶ ÙˆØ£Ø³ÙˆØ¯ Ø­Ø§Ø¯
            pixels[i] = pixels[i+1] = pixels[i+2] = res;
        }
        ctx.putImageData(imgData, 0, 0);

        // 3. ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Øµ
        const { data: { text } } = await worker.recognize(canvas);
        const cleanText = text.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();

        // 4. ÙÙ„ØªØ±Ø© Ø°ÙƒÙŠØ© (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù†Øµ Ø£Ø·ÙˆÙ„ Ù…Ù† Ø®Ø§Ù†ØªÙŠÙ† Ù„Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©)
        if(cleanText.length < 3) {
            failFeedback("Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù„ÙˆØ­Ø© Ø¨ÙˆØ¶ÙˆØ­");
            return;
        }

        const match = dataStore.find(item => {
            const dbPlate = String(item.plate || item['Ø§Ù„Ù„ÙˆØ­Ø©'] || '').replace(/\s+/g, '').toUpperCase();
            // Ù…Ø·Ø§Ø¨Ù‚Ø© ØµØ§Ø±Ù…Ø©: ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ù„ÙˆØ­Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© ÙØ¹Ù„Ø§Ù‹ ÙÙŠ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬
            return dbPlate !== "" && (cleanText.includes(dbPlate) || dbPlate.includes(cleanText));
        });

        if(match) {
            box.className = 'focus-box matched';
            txt.innerText = "ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¨Ù†Ø¬Ø§Ø­!";
            if(navigator.vibrate) navigator.vibrate(200);
            setTimeout(() => { closeCam(); showResult(match); resetUI(); }, 1000);
        } else {
            failFeedback("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù„ÙˆØ­Ø©: " + cleanText);
        }
    }

    function failFeedback(msg) {
        document.getElementById('statusText').innerText = msg;
        document.getElementById('fBox').className = 'focus-box';
        setTimeout(() => {
            document.getElementById('statusText').innerText = "Ø«Ø¨Øª Ø§Ù„Ù„ÙˆØ­Ø© ÙˆØ§Ø¶ØºØ· Ø§Ù„Ø²Ø±";
            document.getElementById('mainBtn').style.display = 'flex';
        }, 2500);
    }

    function showResult(item) {
        document.getElementById('results').innerHTML = `
            <div class="result-card">
                <div class="row"><span>Ø§Ù„Ø¹Ù…ÙŠÙ„:</span><b>${item.client || item['Ø§Ù„Ø¹Ù…ÙŠÙ„']}</b></div>
                <div class="row"><span>Ø§Ù„Ù„ÙˆØ­Ø©:</span><b style="background:#1e293b; color:#fff; padding:2px 8px; border-radius:4px;">${item.plate || item['Ø§Ù„Ù„ÙˆØ­Ø©']}</b></div>
                <div class="row"><span>Ø§Ù„Ù…ÙˆØ¸Ù:</span><b>${item.emp || item['Ø§Ù„Ù…ÙˆØ¸Ù']}</b></div>
                <div class="row"><span>Ø§Ù„Ø­Ø§Ù„Ø©:</span><b style="color:green">${item.status || item['Ø§Ù„Ø­Ø§Ù„Ø©']}</b></div>
            </div>`;
    }

    function resetUI() {
        document.getElementById('fBox').className = 'focus-box';
        document.getElementById('mainBtn').style.display = 'flex';
    }

    function closeCam() {
        if(stream) stream.getTracks().forEach(t => t.stop());
        document.getElementById('camera-ui').style.display = 'none';
    }

    window.onload = loadData;
</script>
</body>
</html>
